---
layout: post
title: 'Pleromaの構築で躓いた点'
tags:
- Pleroma
---

Pleroma を Raspberry Pi 3で構築したときに躓いた点．
基本，[Pleroma / pleroma · GitLab](https://git.pleroma.social/pleroma/pleroma)を見れば良い．
Systemdのテンプレートまである．

[noyuno/pleroma: pleroma instance](https://github.com/noyuno/pleroma)

[s.noyuno.space](https://s.noyuno.space)

### Let's encrypt

- ドメインごとに最大数が決まっているのでDDNSでは実質できない
- `*`で汎用SANはできない
- 再発行は月5回まで．ただしSANの拡張は無制限？

### Nginx

- SSLは`cert.pem`ではなく`fullchain.pem`を指定しないと他のインスタンスからメッセージを送るときに502が出て送れない
    - チェーンがわからないと，鍵の検証ができないため．`curl`でも確認できる．
- `.well-known/`は`certbot`で使いたいかもしれないが，OStatusで使うので`alias`してはならない．
    - 何のエラーも出ないため要注意

### Pleroma

- ログレベルは`error`, `info`, `debug`の3つ．Systemd serviceとして動かすには`error`が現実的．
- `prod`で動かすには`MIX_ENV=prod mix ...`とすべてのコマンドに変数を与える．
- `v0.9.0`も`master`も古く，どんどん仕様が変わっているので，`develop`で建てる．
    - 別にPleroma-FEを持ってくる必要はない
- メールアドレスの認証をしない
- 同一のメールアドレスで登録しようとしても，バックエンドとしても弾かないのでバグる．

### フロントエンド
- ださい
- `/web`にアクセスするとMastodon UI風になる．あくまで「風」
- 通知がMastodon UIとPleroma FEと別に鳴るのでうるさい．
- ユーザに通知する手段が左下のパネルぐらいで少ない
- タイムラインは現在自動更新できている

コマンド

- 起動：`phx.server`
- パスワードリセット：`generate_password_reset username`
    - メールが届かない状況でも，CLIでリンクを作成することはできる．
- モデレータ：`set_moderator username [true|false]`

### OStatus

- Federationはこのインスタンスにいる誰かがフォローしに行かないと流れない．
勝手に何らかのSNSネットワークに繋がってダーと流れるわけではない．
- リモートフォローした時点以降のトゥートしか流れない．

### PostgreSQL

- バージョンのアップグレード前に，古いバージョンのバイナリを`apt`とかで消してはならない．
特に古いバージョンだと「仮想パッケージ」になり`apt`で再インストールできなくなり，
移行時にバックアップからリストアしないといけなくなる（バックアップがないと死ぬ）．
- データベースのディスク使用量を見るには`SELECT datname, pg_size_pretty(pg_database_size(datname)) FROM pg_database;`

### パフォーマンス

- 色々同居させているが480/977MB．いいね
- ログイン，登録は数秒から十数秒かかる．それ以外は快適

### Git

- 手癖で`git clean -fdx`しない
- 更新は`git merge upstream/develop`

### カスタム絵文字

[How to add custom emoji · Wiki · Pleroma / pleroma · GitLab](https://git.pleroma.social/pleroma/pleroma/wikis/How-to-add-custom-emoji)

mstdn.jp の絵文字を拝借するには

1. mstdn.jpでF12を開いてカスタム絵文字が列挙してある部分をコピペして保存する．
2. `jq -r '.custom_emojis[] | "curl -o "+.shortcode+".png "+.url' < emoji.json > download.sh`
3. `find . -type f|while read line ; do f=$(echo $line | awk -F/ '{print $2}'); n=$(echo $f | awk -F. '{print $1}'); echo $n,/emoji/mstdn.jp/$f >> custom_emoji.txt ; done`
4. PNGを`/priv/static/emoji/mstdn.jp/`以下に移動する．
5. `custom_emoji.txt` を `config/custom_emoji.txt` に移動する．
6. Pleromaバックエンドを再起動

[例](https://s.noyuno.space/notice/1593)

カスタム絵文字は，新たなトゥートのみ有効である．

