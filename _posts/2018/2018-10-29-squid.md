---
layout: post
title: 'Squidで快適Docker生活'
tags:
- Squid
- Docker
---

Dockerイメージを開発しているときはDocker内で何度もインストールをし直すため，
そのたびに必要なパッケージのダウンロード処理が発生して時間がかかる．
これを回避するためにSquidでキャッシュサーバを立てて2度目以降のリクエストに対してキャッシュされたデータを返すようにする．

今回は同じコンピュータ（`192.168.11.39`）上に`/mnt/linuxdata/squid/`に保存するSquidサーバを実行した．
以下はすべてホスト側の設定である．ゲスト側の設定は不要である．

### `/etc/squid/squid.conf`

`diff /etc/squid/squid.conf.default /etc/squid/squid.conf`

~~~diff
--- /etc/squid/squid.conf.default       2018-10-01 23:23:56.000000000 +0900
+++ /etc/squid/squid.conf       2018-05-05 21:40:46.000000000 +0900
@@ -5,14 +5,11 @@
 # Example rule allowing access from your local networks.
 # Adapt to list your (internal) IP networks from where browsing
 # should be allowed
-acl localnet src 0.0.0.1-0.255.255.255 # RFC 1122 "this" network (LAN)
-acl localnet src 10.0.0.0/8            # RFC 1918 local private network (LAN)
-acl localnet src 100.64.0.0/10         # RFC 6598 shared address space (CGN)
-acl localnet src 169.254.0.0/16        # RFC 3927 link-local (directly plugged) machines
-acl localnet src 172.16.0.0/12         # RFC 1918 local private network (LAN)
-acl localnet src 192.168.0.0/16                # RFC 1918 local private network (LAN)
-acl localnet src fc00::/7              # RFC 4193 local private network range
-acl localnet src fe80::/10             # RFC 4291 link-local (directly plugged) machines
+acl localnet src 10.0.0.0/8    # RFC1918 possible internal network
+acl localnet src 172.16.0.0/12 # RFC1918 possible internal network
+acl localnet src 192.168.0.0/16        # RFC1918 possible internal network
+acl localnet src fc00::/7       # RFC 4193 local private network range
+acl localnet src fe80::/10      # RFC 4291 link-local (directly plugged) machines

 acl SSL_ports port 443
 acl Safe_ports port 80         # http
@@ -63,6 +60,7 @@

 # Uncomment and adjust the following to add a disk cache directory.
 #cache_dir ufs /var/cache/squid 100 16 256
+cache_dir ufs /mnt/linuxdata/squid 50000 16 256 # 50 GB

 # Leave coredumps in the first cache dir
 coredump_dir /var/cache/squid
@@ -74,3 +72,8 @@
 refresh_pattern ^gopher:       1440    0%      1440
 refresh_pattern -i (/cgi-bin/|\?) 0    0%      0
 refresh_pattern .              0       20%     4320
+
+cache_mem 256 MB
+maximum_object_size 512 MB
+maximum_object_size_in_memory 64 KB
+
~~~


### `~/.docker/config.json`

`httpProxy`には`localhost`や`127.0.0.1`を用いるとエラーになるので注意．

~~~json
{
    "auths": {
        "https://index.docker.io/v1/": {
                "auth": ""
        }
    },
    "HttpHeaders": {
        "User-Agent": "Docker-Client/18.04.0-ce (linux)"
    },
    "proxies": {
        "default": {
            "httpProxy": "http://192.168.11.39:3128"
        }
    }
}
~~~

