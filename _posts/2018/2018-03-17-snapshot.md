---
layout: post
title: 'rsync でファイルのスナップショットを取る'
tags:
- Linux
- rsync
---

rsyncには`--link-dest`を使ってバックアップするとき，
前にバックアップしたファイルから変更されていないファイルを，
ハードリンクとして保持し．変更されたファイルのみをコピーすることができ，
時間の短縮，容量の削減，通信帯域の節減になる．

例として，

~~~
0001 /1/a
0003 /1/b/c
0004 /1/b/d
~~~

があったとして（左はinode），`/b/c`のみが変更されたとき

~~~
0001 /2/a   -> /1/a
0005 /2/b/c
0006 /2/b/d -> /1/b/d
~~~

のように，変更がなかったファイルは前に取ったスナップショットと同じinodeになっていることから，
`/1/`へのハードリンクを貼っている．

また，`--delay-updates`で最後にファイルを反映することができる．

出力については，`-h --info=progress2 -h --info=name0 --remote-option=--log-file=...`
で，端末上には全体の進捗を表示しつつ，リモート側でログを取ることができる．

端末上は

~~~
        20.85G  80%    9.21MB/s    0:35:58 (xfr#133034, to-chk=31133/188255)
~~~

リモートのログファイルは

~~~
2018/03/17 02:33:48 [5115] >f+++++++++ YukariAkiyamaHubotSlack/bin/hubot
~~~

の形式で保存される．

$HOME以下をリモートにバックアップするプログラム：

[dotfiles/backup at master · noyuno/dotfiles](https://github.com/noyuno/dotfiles/blob/master/bin/backup)

（これは，直前に取ったスナップショットへのハードリンクを貼る．）

