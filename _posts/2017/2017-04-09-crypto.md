---
layout: post
title: dm-cryptを使った/homeの暗号化とUSBでの解錠
tags:
- linux
- encryption
- partitioning
#image: /blog/images/
---

自動でLVMパーティションを作成し，dm-cryptを使って/homeを暗号化し，起動時にUSBからロック解錠をする．

# 0. インストーラを起動，スクリプトを取得

[dotfiles/install.sh at master · noyuno/dotfiles](https://github.com/noyuno/dotfiles/blob/master/autoinstall/install.sh)

```sh
sudo su -
wget https://raw.githubusercontent.com/noyuno/dotfiles/master/autoinstall/install.sh
```

# 1. パーティションの作成

LVMの構築や暗号化まで全部やる．

構造

1. /dev/sda1 /boot/efi fat32 100MB
2. /dev/sda2 lvm(vg0)
    1. /dev/vg0/lv0 / ext4 ${2}B
    2. /dev/vg0/lv1 **luks**
        - /dev/mapper/crypto-vg0-lv1 /home ext4 残り
3. bios_grub 34-1041セクタ

```sh
bash install.sh /dev/sda 20G # root partition size
```

```sh
partitioning()
{
    target=$1
    rootsize=$2
    
    dfx parted -s "$target" -a optimal -- \
        mklabel gpt \
        mkpart primary 1 100M \
        set 1 boot on \
        mkpart primary 100M -1 \
        set 2 lvm on \
        mkpart primary 34s 1041s \
        set 3 bios_grub on
    dfx sync
    dfx mkfs.vfat -F 32 "$target"1
    dfx pvcreate -ff "$target"2
    dfx vgcreate vg0 "$target"2
    dfx lvcreate -L "$rootsize" -n lv0 vg0
    dfx lvcreate -l 100%FREE -n lv1 vg0
    dfx mkfs.ext4 /dev/vg0/lv0
    dfx cryptsetup luksFormat -c aes-xts-plain64 -s 512 /dev/vg0/lv1
    dfx cryptsetup open --type luks /dev/vg0/lv1 $cryptoname
    dfx mkfs.ext4 /dev/mapper/$cryptoname
    dfx sync
}
```

# 2. インストーラからシステムをインストール

手動でパーティションを割り当てる．1.で終わっているので切る必要はない．

# 3. USBからロック解除ができるようにする

luksのkeyfileをhostnameごとにUSBに格納．
起動時にPCにUSBが刺さっていれば解錠できる．
initramfsでの解錠はうまくいかなかったのでrc.localから．
lightdm表示後数秒はログインできないので少し待つ．

USBをなくしたときは当然$HOMEが無いからlightdmが通さないので，VTからログインしてluksスロット0パスワードを入力．
また，`cryptsetup luksRemoveKey`で失効できる．

    parted -s /dev/sdb mklabel msdos mkpart primary 1 -1
    mkfs.vfat -F 32 /dev/sdb1
    bash install.sh luks /dev/sdb1

```sh
luks()
{
    usbd="$1"
    usbuuid=$(sudo blkid|grep "^$usbd:"|sed -e 's/.* UUID="//' -e 's/" .*//')
    rclocal=/etc/rc.local
    dfout2 "usbuuid=$usbuuid"

    mount | grep "^$1 " >/dev/null &&:
    if [ $? -ne 0 ]; then
        dfx umount "$1"
    fi
    if [ ! -e "/dev/mapper/$cryptoname" ]; then
        dfx cryptsetup open --type luks /dev/vg0/lv1 $cryptoname
    fi
    dfx mkdir -p /target
    dfx mkdir -p /mnt/luksusb
    targetmount /dev/vg0/lv0 /target
    targetmount "$usbd" /mnt/luksusb

    keyfile=/cryptokey/$(cat /target/etc/hostname)
    dfx mkdir -p /mnt/luksusb/cryptokey
    dfx cat /dev/urandom '|' \
        tr -dc 'a-zA-Z0-9' '|' \
        fold -w 64 '|' head -n 32 '|' sort '|' uniq '>' /mnt/luksusb$keyfile
    dfx cryptsetup luksAddKey /dev/vg0/lv1 /mnt/luksusb$keyfile

    dfx sed -i -e "s|^/dev/mapper/$cryptoname |#&|" /target/etc/fstab
    dfout3 "/target$rclocal"
    cat << EOF > /target$rclocal
#!/bin/sh -e
# mount /home from luks encrypted /dev/vg0/lv1
mkdir -p /mnt/luksusb
mount /dev/disk/by-uuid/$usbuuid /mnt/luksusb
cryptsetup open --type luks /dev/vg0/lv1 $cryptoname --key-file /mnt/luksusb/$keyfile
mount /dev/mapper/$cryptoname /home
sync
exit 0
EOF

    dfx chroot /target update-initramfs -u
}
```

# 4. reboot

# 参考文献

- [dm-crypt/システム全体の暗号化 - ArchWiki](https://wiki.archlinuxjp.org/index.php/Dm-crypt/%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E5%85%A8%E4%BD%93%E3%81%AE%E6%9A%97%E5%8F%B7%E5%8C%96)
